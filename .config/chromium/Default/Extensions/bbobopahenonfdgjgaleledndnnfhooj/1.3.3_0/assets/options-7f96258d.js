import{b as M,P as i,d as D,e as y,f as h,c as b,a as w}from"./chunk-QIZ4XBKF-980296cc.js";var L=(o="")=>{const u=M();let a,r=[];const t=h(),d=new Set,g=new Set,v=(e,l)=>{switch(e.status){case"undeliverable":r.some(s=>s.message.messageID===e.message.messageID)||(r=[...r,{message:e.message,resolvedDestination:e.resolvedDestination}]);return;case"deliverable":r=r.reduce((s,n)=>n.resolvedDestination===e.deliverableTo?(i.toBackground(l,{type:"deliver",message:n.message}),s):[...s,n],[]);return;case"delivered":e.receipt.message.messageType==="message"&&t.add(e.receipt);return;case"incoming":e.message.messageType==="reply"&&t.remove(e.message.messageID),d.forEach(s=>s(e.message,l));return;case"terminated":{const s=t.entries().filter(n=>e.fingerprint===n.to);t.remove(s),s.forEach(({message:n})=>g.forEach(f=>f(n)))}}},p=()=>{a=D.runtime.connect({name:y({endpointName:o,fingerprint:u})}),a.onMessage.addListener(v),a.onDisconnect.addListener(p),i.toBackground(a,{type:"sync",pendingResponses:t.entries(),pendingDeliveries:[...new Set(r.map(({resolvedDestination:e})=>e))]})};return p(),{onFailure(e){g.add(e)},onMessage(e){d.add(e)},postMessage(e){i.toBackground(a,{type:"deliver",message:e})}}},m=L("options"),c=b("options",o=>m.postMessage(o));m.onMessage(c.handleMessage);var{sendMessage:P,onMessage:R}=c;w(c);export{L as c,P as s};
